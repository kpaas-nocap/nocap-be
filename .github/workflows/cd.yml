name: NOCAP-BE CD
on:
  workflow_run:
    workflows: ["NOCAP-BE CI"]
    types: [completed]
jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-kubectl@v4
      - name: Write kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config
      - name: Create or update imagePullSecret
        run: |
          kubectl create namespace nocap --dry-run=client -o yaml | kubectl apply -f -
          kubectl -n nocap delete secret ncr-cred --ignore-not-found
          kubectl -n nocap create secret docker-registry ncr-cred \
            --docker-server=${{ secrets.NCR_REGISTRY }} \
            --docker-username=${{ secrets.NCR_USERNAME }} \
            --docker-password=${{ secrets.NCR_PASSWORD }}
      - name: Create or update app-secrets
        env:
          SPRING_DATASOURCE_URL: ${{ secrets.APP_DB_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.APP_DB_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.APP_DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          KAKAO_CLIENT: ${{ secrets.KAKAO_CLIENT }}
          KAKAO_SECRET: ${{ secrets.KAKAO_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          FASTAPI_SERVER_URL: ${{ secrets.FASTAPI_SERVER_URL }}
        run: |
          kubectl -n nocap delete secret app-secrets --ignore-not-found
          kubectl -n nocap create secret generic app-secrets \
            --from-literal=SPRING_DATASOURCE_URL="$SPRING_DATASOURCE_URL" \
            --from-literal=SPRING_DATASOURCE_USERNAME="$SPRING_DATASOURCE_USERNAME" \
            --from-literal=SPRING_DATASOURCE_PASSWORD="$SPRING_DATASOURCE_PASSWORD" \
            --from-literal=JWT_SECRET="$JWT_SECRET" \
            --from-literal=KAKAO_CLIENT="$KAKAO_CLIENT" \
            --from-literal=KAKAO_SECRET="$KAKAO_SECRET" \
            --from-literal=OPENAI_API_KEY="$OPENAI_API_KEY" \
            --from-literal=MAIL_USERNAME="$MAIL_USERNAME" \
            --from-literal=MAIL_PASSWORD="$MAIL_PASSWORD" \
            --from-literal=FASTAPI_SERVER_URL="$FASTAPI_SERVER_URL"
      - name: Apply manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/deployment.yaml
      - name: Rollout new image
        run: |
          IMAGE=${{ secrets.NCR_REGISTRY }}/${{ secrets.NCR_REPOSITORY }}:${{ github.event.workflow_run.head_sha }}
          kubectl -n nocap set image deploy/nocap-be nocap-be=$IMAGE
          kubectl -n nocap rollout status deploy/nocap-be --timeout=300s
